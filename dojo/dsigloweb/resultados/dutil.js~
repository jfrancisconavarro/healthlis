dojo.provide("dsiglo.peticiones.dutil");

dojo.declare(
"dutil",null,
{
	getAge: function (d1,d2) //YYYY/MM/DD
	{
		var diff = Math.abs(d2.getTime()  - d1.getTime());
		return Math.ceil( diff / (1000 * 3600 * 24) );	
	},
	hoy: function ()
	{
		var today = new Date();
		var dd = today.getDate();
		var mm = today.getMonth()+1; //January is 0!
		var yyyy = today.getFullYear();
		
		if(dd<10) {
		    dd='0'+dd
		} 
		
		if(mm<10) {
		    mm='0'+mm
		} 
		
		today = dd+'/'+mm+'/'+yyyy;
		return today;
	},
	convfecha: function (d1) //DD/MM/YYYY to yyyymmdd
	{
		var ano = d1.substring(6,10);
		var mes = d1.substring(3,5);
		var dia = d1.substring(0,2);
		return ano+mes+dia;
	},	
	sum15fecha: function (d1) //DD/MM/YYYY
	{
		var ano = d1.substring(6,10);
		var mes = d1.substring(3,5);
		var dia = d1.substring(0,2);
		var sum = parseInt(dia);
		if( (parseInt(dia) - parseInt(15))<0 )
		{
			sum = sum + parseInt(15);
			mes = mes - parseInt(1);
		}
		else
		{
			sum = sum - parseInt(15);
		}
		
		//console.log("ini1"+ano+'/'+mes+'/'+dia+'.Suma:'+sum);
		if( mes == "02" )
		{
			if( sum>28)
			{
				sum=sum-28;
				mes=parseInt(mes)-parseInt(1);
			}
			//console.log("ini3"+ano+'/'+mes+'/'+dia+'.Suma:'+sum);
		}
		else if( mes%2 == 0 ) // 30 dias
		{
			if( sum>30)
			{
				sum=sum-30;
				mes=parseInt(mes)-parseInt(1);
				if( parseInt(mes)>12 )
				{ 
					mes = "1";
					ano = parseInt(ano) - parseInt(1);
				}				
			}
			//console.log("ini4"+ano+'/'+mes+'/'+dia+'.Suma:'+sum);
		}
		else
		{
			if( sum>31)
			{
				sum=sum-31;
				mes=parseInt(mes)-parseInt(1);
				if( parseInt(mes)>12 )
				{ 
					mes = "1";
					ano = parseInt(ano) - parseInt(1);
				}		
			}
			//console.log("ini5"+ano+'/'+mes+'/'+dia+'.Suma:'+sum);
		}
		dia=sum;
		dia=parseInt(dia);
		mes=parseInt(mes);
		ano=parseInt(ano);
		if( parseInt(dia)<10 ) dia = "0" +dia;
		if( parseInt(mes)<10 ) mes = "0" +mes;
		//console.log("ini6"+ano+'/'+mes+'/'+dia+'.Suma:'+sum);
		return ano+mes+dia; 
	},
	ltarjetas: function( tipocampo, pdato )
	{
		console.log("Regexp:"+tipocampo+"-"+pdato);
		if( eval(pdato)>0 )
		{
			if( tipocampo=='N') //entero
			{
				return "\\d{"+pdato+"}";
			}
			else if( tipocampo=='T') //Texto
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='X') //Texto Fijo
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='-') //Respetar texto
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='F') //Fecha
			{
				return "(0[1-9]|[12][0-9]|3[01])[- \\/.](0[1-9]|1[012])[- \\/.](19|20)\\d\\d";
			}
			else if( tipocampo=='C') //Cualitativa
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='T1') //T1
			{
				//xxxxxx-x-xxx
				return "(\\d{6}-\\d{1}-\\d{3})";
			}
			else if( tipocampo=='T2') //T2
			{
				//xxxx-xxxx-xxxx-xxxx รณ xxxx-xxxx-x
				return "(\\d{4}-\\d{4}-\\d{1})|(\\d{4}-\\d{4}-\\d{4}-\\d{4})";
			}
			else if( tipocampo=='T3') //T3
			{
				//xx-xxxxxxxxxx
				return "(\\d{2}-\\d{10})";
			}
			else if( tipocampo=='T4') //T4
			{
				//xx/xxxxxxxxx/xx
				return "(\\d{2}/\\d{10}/\\d{2})";
			}
			else if( tipocampo=='T5') //T5
			{
				//xxxx-xxxx o xxxx-xxxx-xxxx-xxxx
				return "(\\d{4}-\\d{4})|(\\d{4}-\\d{4}-\\d{4}-\\d{4})";
				
			}
			else if( tipocampo=='T6') //T6
			{
				//xxxx-xxxxxxxx-xxxxxx
				// o xxxx
				//o xxxxxx-xxxxxx-xxxxxxxx-xxxx
				return "(\\d{4}-\\d{8}-\\d{6})|(\\d{4})|(\\d{6}-\\d{6}-\\d{8}-\\d{4})";
			}
			else if( tipocampo=='T7') //T7
			{
				//xx/xxxxxxxxx/xx
				return "(\\d{2}/\\d{9}/\\d{2})";
			}
			else if( tipocampo=='T8') //T8
			{
				//xxxx-xxxx-xxxx
				//xxxx-xxxx-xxxx-xxxxxx
				return "(\\d{4}-\\d{4}-\\d{4})|(\\d{4}-\\d{4}-\\d{4}-\\d{6})";
			}
			else if( tipocampo=='LF') //Luhn Financiera
			{
				return "\\d{"+pdato+"}";
			}
			else if( tipocampo=='LS') //Luhn Sanitaria
			{
				return "\\d{"+pdato+"}";
			}
			else if( tipocampo=='LX') //Caja Salud
			{
				return "\\d{"+pdato+"}";
			}
		}
		else 
		{
			if( tipocampo=='N') //entero
			{
				return "\\d{"+pdato+"}";
			}
			else if( tipocampo=='T') //Texto
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='X') //Texto Fijo
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='-') //Respetar texto
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='F') //Fecha
			{
				return "(0[1-9]|[12][0-9]|3[01])[- \\/.](0[1-9]|1[012])[- \\/.](19|20)\\d\\d";
			}
			else if( tipocampo=='C') //Cualitativa
			{
				return "\\w{"+pdato+"}";
			}
			else if( tipocampo=='T1') //T1
			{
				//xxxxxx-x-xxx
				return "(\\d{6}-\\d{1}-\\d{3})";
			}
			else if( tipocampo=='T2') //T2
			{
				//xxxx-xxxx-xxxx-xxxx รณ xxxx-xxxx-x
				return "(\\d{4}-\\d{4}-\\d{1})|(\\d{4}-\\d{4}-\\d{4}-\\d{4})";
			}
			else if( tipocampo=='T3') //T3
			{
				//xx-xxxxxxxxxx
				return "(\\d{2}-\\d{10})";
			}
			else if( tipocampo=='T4') //T4
			{
				//xx/xxxxxxxxx/xx
				return "(\\d{2}/\\d{10}/\\d{2})";
			}
			else if( tipocampo=='T5') //T5
			{
				//xxxx-xxxx o xxxx-xxxx-xxxx-xxxx
				return "(\\d{4}-\\d{4})|(\\d{4}-\\d{4}-\\d{4}-\\d{4})";
				
			}
			else if( tipocampo=='T6') //T6
			{
				//xxxx-xxxxxxxx-xxxxxx
				// o xxxx
				//o xxxxxx-xxxxxx-xxxxxxxx-xxxx
				return "(\\d{4}-\\d{8}-\\d{6})|(\\d{4})|(\\d{6}-\\d{6}-\\d{8}-\\d{4})";
			}
			else if( tipocampo=='T7') //T7
			{
				//xx/xxxxxxxxx/xx
				return "(\\d{2}/\\d{9}/\\d{2})";
			}
			else if( tipocampo=='T8') //T8
			{
				//xxxx-xxxx-xxxx
				//xxxx-xxxx-xxxx-xxxxxx
				return "(\\d{4}-\\d{4}-\\d{4})|(\\d{4}-\\d{4}-\\d{4}-\\d{6})";
			}
			else if( tipocampo=='LF') //Luhn Financiera
			{
				return "\\d{"+pdato+"}";
			}
			else if( tipocampo=='LS') //Luhn Sanitaria
			{
				return "\\d{"+pdato+"}";
			}
			else if( tipocampo=='LX') //Caja Salud
			{
				return "\\d{"+pdato+"}";
			}
		}
			
	},
	vtarjetas: function ( tipocampo, valor )
	{
		console.log("Validando Tarjeta:"+tipocampo+" con valor:"+valor);		
		if( tipocampo=='N') //entero
		{
			return Number(valor) === valor && valor % 1 === 0;
		}
		else if( tipocampo=='T') //Texto
		{

		}
		else if( tipocampo=='X') //Texto Fijo
		{

		}
		else if( tipocampo=='-') //Respetar texto
		{

		}
		else if( tipocampo=='F') //Fecha
		{
			
		}
		else if( tipocampo=='C') //Cualitativa
		{

		}
		else if( tipocampo=='T0') //T0
		{

		}
		else if( tipocampo=='T1') //T1
		{

		}
		else if( tipocampo=='T2') //T2
		{

		}
		else if( tipocampo=='T3') //T3
		{

		}
		else if( tipocampo=='T4') //T4
		{

		}
		else if( tipocampo=='T5') //T5
		{

		}
		else if( tipocampo=='T6') //T6
		{

		}
		else if( tipocampo=='T7') //T7
		{

		}
		else if( tipocampo=='T8') //T8
		{

		}
		else if( tipocampo=='LF') //Luhn Financiera
		{

		}
		else if( tipocampo=='LS') //Luhn Sanitaria
		{

		}
		else if( tipocampo=='LX') //Caja Salud
		{

		}
	},
	vluhns: function( valor )
	{
		var F = false;		
		var CHK = 0;
		var L = valor.length;
		var sec = [1,2,3,4,5,6,7,8,9];
		for (I = 0; I < L; I++) 
		{
			C=parseInt(valor[L-I])-48;
			if( sec.indexOf(C) != -1 )
			{
				if( I%2==0 ){ C=C*2; }
    			CHK = CHK + C;
			}
			else 
			{
				break;
			}				
		}
		return (F && (CHK%10==0));
		
	},
	vluhnf: function( valor )
	{
		var F = false;		
		var CHK = 0;
		var L = valor.length;
		var sec = [1,2,3,4,5,6,7,8,9];
		for (I = 0; I < L; I++) 
		{
			C=parseInt(valor[L-I])-48;
			if( sec.indexOf(C) != -1 )
			{
				if( I%2==0 ){ C=C*2; }
    			CHK = CHK + C%10;
				CHK = CHK + C/10;
			}
			else 
			{
				break;
			}				
		}
		return (F && (CHK%10==0));
	},
	vtarjeta0: function( ID, S ) 
	{
		// ID prefijo
		// S tarjeta
		// Comprueba tarjetas de tipo 0 (ABCD123456789012)
		// Devuelve T24 si OK
		var result="";
		var T = "";
		var C = "";			
		var CHK = 0;
		var sec = ["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","U","V","W","X","Y","Z"]
		var sec2 = [" ","-",".","/"];
		var L = S.length;
		for (I = 1; I = L; I++) 
		{
			C=S[I].toUpperCase();
			if( sec.indexOf(C) != -1 )
			{
				T=T+C;
			}
			else if( sec2.indexOf(S[I]) == -1 )
			{
				return;			
			}	
		}
		L=T.length;
		if (L==16)
		{
			 var K1=(parseInt(T[1])-62)*30+parseInt(T[2])-54;
		    var K2=(parseInt(T[3])-62)*30+parseInt(T[4])-54;
		    if ( K1>100 && K2>100 )
		    {
		    	T=ID+K1+K2+T.substr(5, 12);
				L=24;
		    }
		}
		if ( L==24 && vluhnf(T) )
		{
			return T;
		} 
	},
	vtarjeta1: function( ID, S ) 
	{
		// ID prefijo
		// S tarjeta
		// Comprueba tarjetas de tipo 1 (xxxxxx-x-xxx)
		// Devuelve T24 si OK
		var result="";
		var T = "";
		var C = "";			
		var CHK = 0;
		var sec = ["0","1","2","3","4","5","6","7","8","9"];
		var sec2 = [" ","-",".","/"];
		var sec3 = [10,11,12,13,14,15,16,17,18];
		var L = S.length;
		for (I = 1; I = L; I++) 
		{
			if( sec.indexOf(S[I]) != -1 )
			{
				T=T+S[I];
			}
			else if( sec2.indexOf(S[I]) == -1 )
			{
				return;			
			}	
		}
		L=T.length;
		if ( sec3.indexOf(L) != -1 )
		{
			for( I=1; I=18-L; I++ )
			{
				T=T.substr(0,7);
				T=T+'0';	
				T=ID+T;
     			L=24;
			}
		}
		if ( L==24 && vluhns(T) )
		{
			return T;
		} 
	},
	vtarjeta2: function( ID, S ) 
	{
		// ID prefijo
		// S tarjeta
		// Comprueba tarjetas de tipo 2 (xxxx-xxxx-xxxx-xxxx รณ xxxx-xxxx-x)
		// Devuelve T24 si OK
		var result="";
		var T = "";
		var C = "";			
		var CHK = 0;
		var sec = ["0","1","2","3","4","5","6","7","8","9"];
		var sec2 = [" ","-",".","/"];
		var sec3 = [10,11,12,13,14,15,16,17,18];
		var L = S.length;
		for (I = 1; I = L; I++) 
		{
			if( sec.indexOf(S[I]) != -1 )
			{
				T=T+S[I];
			}
			else if( sec2.indexOf(S[I]) == -1 )
			{
				return;			
			}	
		}
		L=T.length;
		if( L==9 )
		{
			if( !vluhns(T) )
			{
				return;			
			}
			T=ID+"0000000"+T.substr(1,8)+T[9];
			L=T.length;
		}
		else if( L==16 )
		{
			if( !vluhns(T) )
			{
				return;			
			}
			T=ID+"0"+T.substr(10,3)+'000'+T.substr(1,8)+'00'+T[9];
			L=T.length;
		}
		
		if ( L==24 && vluhns(T) )
		{
			return T;
		} 
	},
	vtarjeta3: function( ID, S ) 
	{
		// ID prefijo
		// S tarjeta
		// Comprueba tarjetas de tipo 3 (xx-xxxxxxxxxx)
		// Devuelve T24 si OK
		var result="";
		var T = "";
		var C = "";			
		var CHK = 0;
		var sec = ["0","1","2","3","4","5","6","7","8","9"];
		var sec2 = [" ","-",".","/"];
		var sec3 = [10,11,12,13,14,15,16,17,18];
		var L = S.length;
		for (I = 1; I = L; I++) 
		{
			if( sec.indexOf(S[I]) != -1 )
			{
				T=T+S[I];
			}
			else if( sec2.indexOf(S[I]) == -1 )
			{
				return;			
			}	
		}
		L=T.length;
		if( L==16 && ID.length==8 )
		{
			T=ID+T;
		}
		L=T.length;
		if( L==12 )
		{
			T=T.substr(0,12)+"00"+T.substr(13,L-1);
			T=ID+"0000"+T;
			L=24;
		}
		
		if ( L==24 && vluhns(T) )
		{
			return T;
		} 
	}
}	
);
